<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Interview Copilot</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Highlight.js for code blocks -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        body {
            background-color: #000000;
            color: #ffffff;
            font-family: sans-serif;
        }

        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }

        .btn-action {
            touch-action: manipulation;
        }

        .speaker-0 {
            color: #60a5fa;
        }

        .speaker-1 {
            color: #f472b6;
        }

        .tab-active {
            border-bottom: 2px solid #10b981;
            color: #10b981;
        }

        .tab-inactive {
            color: #6b7280;
        }

        .locked-border {
            border: 2px solid #ef4444;
        }

        .interim {
            color: #9ca3af;
            font-style: italic;
        }

        /* Code block styling */
        .code-wrapper {
            position: relative;
            margin: 8px 0;
            border-radius: 8px;
            overflow: hidden;
        }

        .code-wrapper pre {
            margin: 0;
            padding: 12px;
            padding-top: 32px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.4;
            background: #161b22 !important;
            border-radius: 8px;
        }

        .code-wrapper code {
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
        }

        .copy-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            background: #30363d;
            color: #c9d1d9;
            border: 1px solid #484f58;
            border-radius: 6px;
            padding: 3px 10px;
            font-size: 11px;
            cursor: pointer;
            z-index: 10;
            transition: background 0.2s;
        }

        .copy-btn:active {
            background: #238636;
        }

        .lang-label {
            position: absolute;
            top: 7px;
            left: 10px;
            font-size: 10px;
            color: #8b949e;
            font-family: monospace;
            text-transform: uppercase;
        }

        /* Streaming cursor */
        .streaming-cursor::after {
            content: '‚ñä';
            animation: blink 0.8s infinite;
            color: #10b981;
        }

        @keyframes blink {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0;
            }
        }

        /* Snap badge */
        .snap-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .snap-bar {
            display: flex;
            gap: 6px;
            align-items: center;
            padding: 6px 8px;
            background: #1e1028;
            border: 1px solid #7c3aed;
            border-radius: 8px;
            margin-bottom: 6px;
        }

        /* Resize handle */
        .resize-handle {
            height: 12px;
            min-height: 12px;
            cursor: row-resize;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }

        .resize-handle .handle-bar {
            width: 40px;
            height: 4px;
            border-radius: 2px;
            background: #4b5563;
            transition: background 0.2s;
        }

        .resize-handle:active .handle-bar {
            background: #10b981;
        }

        .panel-container {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        /* Image menu popup */
        .image-menu-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 100px;
        }

        .image-menu {
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 12px;
            padding: 6px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 180px;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.4);
        }

        .image-menu button {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            color: white;
            border: none;
            cursor: pointer;
        }

        .image-menu button:active {
            opacity: 0.8;
        }
    </style>
</head>

<body class="h-screen flex flex-col p-4">

    <!-- Mode Switcher -->
    <div class="flex justify-around mb-4 border-b border-gray-800">
        <button onclick="setMode('manual')" id="tab-manual"
            class="pb-2 w-1/2 font-bold text-center tab-active">MANUAL</button>
        <button onclick="setMode('auto')" id="tab-auto"
            class="pb-2 w-1/2 font-bold text-center tab-inactive">AUTO-PILOT</button>
    </div>

    <!-- Status Bar -->
    <div class="flex justify-between items-center mb-2">
        <div class="flex flex-col">
            <div id="status-indicator" class="text-xs font-mono text-gray-400">Ready</div>
            <div id="debug-info" class="text-[10px] font-mono text-gray-600">Chunks: 0</div>
        </div>
        <div id="connection-dot" class="w-3 h-3 rounded-full bg-red-500"></div>
    </div>

    <!-- Context Toggle -->
    <details class="mb-2 border border-gray-800 rounded bg-gray-900">
        <summary class="p-2 text-xs text-gray-400 font-bold cursor-pointer">CONTEXT / RESUME</summary>
        <textarea id="context-input" oninput="syncContext()"
            class="w-full h-24 bg-gray-800 text-white text-sm p-2 outline-none"
            placeholder="Paste resume here..."></textarea>
    </details>

    <!-- Resizable Panel Container -->
    <div class="panel-container">
        <!-- Transcript Area -->
        <div id="transcript-box" contenteditable="true"
            class="overflow-y-auto border border-gray-800 rounded-lg p-2 text-gray-400 text-sm leading-snug"
            style="flex: 1; min-height: 40px;">
            <p class="italic opacity-50">Conversation will appear here...</p>
        </div>

        <!-- Drag Handle -->
        <div class="resize-handle" id="resize-handle">
            <div class="handle-bar"></div>
        </div>

        <!-- Answer Area -->
        <div id="answer-box"
            class="overflow-y-auto bg-gray-900 rounded-lg p-4 border border-gray-700 shadow-lg shadow-emerald-900/20 transition-colors duration-300"
            style="flex: 2; min-height: 40px;">
            <p class="text-gray-500 text-center mt-10">Select a mode to begin.</p>
        </div>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="camera-input" accept="image/*" capture="environment" class="hidden">
    <input type="file" id="upload-input" accept="image/*" multiple class="hidden">

    <!-- Image Menu Popup -->
    <div id="image-menu-overlay" class="image-menu-overlay hidden" onclick="closeImageMenu()">
        <div class="image-menu" onclick="event.stopPropagation()">
            <button onclick="openCamera()" style="background:#7c3aed">üì∑ Take Photo</button>
            <button onclick="openUpload()" style="background:#4f46e5">üìÅ Upload from Gallery</button>
        </div>
    </div>

    <!-- Snap Queue Bar (hidden by default) -->
    <div id="snap-bar" class="snap-bar hidden">
        <span class="text-purple-400 text-xs font-bold" id="snap-count">0 snaps</span>
        <div class="flex-grow"></div>
        <button onclick="solveSnaps()"
            class="bg-purple-600 active:bg-purple-500 text-white text-xs font-bold px-3 py-1.5 rounded-md">‚ú®
            SOLVE</button>
        <button onclick="clearSnaps()" class="bg-gray-700 text-gray-300 text-xs font-bold px-3 py-1.5 rounded-md">‚úï
            CLEAR</button>
    </div>

    <!-- CONTROLS -->
    <div class="h-20 mt-2">
        <div id="controls-manual" class="grid grid-cols-3 gap-2 h-full">
            <button id="btn-manual-mic" onclick="toggleMic()"
                class="bg-gray-700 rounded-lg flex flex-col items-center justify-center btn-action">
                <span class="text-2xl">üéôÔ∏è</span>
                <span class="text-xs font-bold mt-1">LISTEN</span>
            </button>
            <button onclick="manualGetAnswer()"
                class="bg-emerald-600 active:bg-emerald-500 text-white rounded-lg flex flex-col items-center justify-center btn-action shadow-lg">
                <span class="text-2xl">‚ö°</span>
                <span class="text-xs font-bold mt-1">ANSWER</span>
            </button>
            <button onclick="captureImage()"
                class="relative bg-purple-600 active:bg-purple-500 text-white rounded-lg flex flex-col items-center justify-center btn-action shadow-lg">
                <span id="snap-badge-manual" class="snap-badge hidden">0</span>
                <span class="text-2xl">üì∑</span>
                <span class="text-xs font-bold mt-1">IMAGE</span>
            </button>
        </div>

        <div id="controls-auto" class="grid grid-cols-5 gap-2 h-full hidden">
            <button id="btn-auto-mic" onclick="toggleMic()"
                class="col-span-1 bg-gray-700 rounded-lg flex items-center justify-center text-2xl btn-action">
                üéôÔ∏è
            </button>
            <button onclick="forceAnswer()"
                class="col-span-3 bg-blue-600 active:bg-blue-500 text-white font-bold text-lg rounded-lg shadow-lg btn-action">
                FORCE ANSWER
            </button>
            <button onclick="captureImage()"
                class="relative col-span-1 bg-purple-600 active:bg-purple-500 rounded-lg flex items-center justify-center text-2xl btn-action">
                <span id="snap-badge-auto" class="snap-badge hidden">0</span>
                üì∑
            </button>
        </div>
    </div>

    <script>
        const socket = io();
        let mediaRecorder;
        let isRecording = false;
        let wakeLock = null;
        let chunkCount = 0;
        let currentMode = 'manual';
        let currentInterimElement = null;
        let streamingRaw = '';
        let isStreaming = false;
        let latestInterimText = '';  // Track latest interim for fast answer requests

        async function requestWakeLock() {
            try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) { }
        }

        function syncContext() {
            const context = document.getElementById('context-input').value;
            socket.emit('update_context', { context: context });
        }

        // --- RENDER ANSWER WITH CODE BLOCKS ---
        function renderAnswer(raw) {
            // Parse markdown code blocks: ```lang\ncode\n```
            const codeBlockRegex = /```(\w*)\n([\s\S]*?)```/g;
            let result = '';
            let lastIndex = 0;
            let match;
            let blockId = 0;

            while ((match = codeBlockRegex.exec(raw)) !== null) {
                // Text before this code block
                const textBefore = raw.substring(lastIndex, match.index);
                result += formatText(textBefore);

                const lang = match[1] || 'plaintext';
                const code = match[2].trim();
                const id = `code-block-${Date.now()}-${blockId++}`;

                // Highlight.js
                let highlighted;
                try {
                    highlighted = hljs.highlight(code, { language: lang }).value;
                } catch {
                    highlighted = hljs.highlightAuto(code).value;
                }

                result += `
                    <div class="code-wrapper">
                        <span class="lang-label">${lang}</span>
                        <button class="copy-btn" onclick="copyCode('${id}')">üìã Copy</button>
                        <pre><code id="${id}" class="hljs language-${lang}">${highlighted}</code></pre>
                    </div>`;

                lastIndex = match.index + match[0].length;
            }

            // Remaining text after last code block
            result += formatText(raw.substring(lastIndex));
            return `<div class="text-white text-base leading-relaxed">${result}</div>`;
        }

        function formatText(text) {
            if (!text.trim()) return '';
            let formatted = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/`([^`]+)`/g, '<code class="bg-gray-800 px-1 py-0.5 rounded text-sm text-emerald-400">$1</code>')
                .replace(/^- /gm, '‚Ä¢ ')
                .replace(/\n/g, '<br>');
            return `<span>${formatted}</span>`;
        }

        function copyCode(id) {
            const codeEl = document.getElementById(id);
            const text = codeEl.innerText;
            navigator.clipboard.writeText(text).then(() => {
                const btn = codeEl.closest('.code-wrapper').querySelector('.copy-btn');
                btn.innerText = '‚úÖ Copied';
                setTimeout(() => { btn.innerText = 'üìã Copy'; }, 1500);
            });
        }

        // --- MULTI-IMAGE CAPTURE ---
        let snapQueue = [];

        function updateSnapUI() {
            const count = snapQueue.length;
            const bar = document.getElementById('snap-bar');
            const countEl = document.getElementById('snap-count');
            const badgeManual = document.getElementById('snap-badge-manual');
            const badgeAuto = document.getElementById('snap-badge-auto');

            if (count > 0) {
                bar.classList.remove('hidden');
                countEl.innerText = `${count} snap${count > 1 ? 's' : ''} queued`;
                badgeManual.classList.remove('hidden');
                badgeManual.innerText = count;
                badgeAuto.classList.remove('hidden');
                badgeAuto.innerText = count;
            } else {
                bar.classList.add('hidden');
                badgeManual.classList.add('hidden');
                badgeAuto.classList.add('hidden');
            }
        }

        function clearSnaps() {
            snapQueue = [];
            updateSnapUI();
        }

        function solveSnaps() {
            if (snapQueue.length === 0) return;
            const box = document.getElementById('answer-box');
            box.innerHTML = `<div class="flex justify-center items-center h-full"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-400"></div><span class="ml-3 text-purple-400">Analyzing ${snapQueue.length} image(s)...</span></div>`;
            // Send transcript text so AI can use conversation context (e.g. "solve in C++")
            const transcriptText = document.getElementById('transcript-box').innerText.trim();
            socket.emit('process_image', { images: snapQueue, transcript: transcriptText });
            snapQueue = [];
            updateSnapUI();
        }

        function captureImage() {
            document.getElementById('image-menu-overlay').classList.remove('hidden');
        }

        function closeImageMenu() {
            document.getElementById('image-menu-overlay').classList.add('hidden');
        }

        function openCamera() {
            closeImageMenu();
            document.getElementById('camera-input').click();
        }

        function openUpload() {
            closeImageMenu();
            document.getElementById('upload-input').click();
        }

        function handleImageFiles(files) {
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = () => {
                    const b64 = reader.result.split(',')[1];
                    snapQueue.push(b64);
                    updateSnapUI();
                };
                reader.readAsDataURL(file);
            });
        }

        document.getElementById('camera-input').addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleImageFiles(e.target.files);
            e.target.value = '';
        });

        document.getElementById('upload-input').addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleImageFiles(e.target.files);
            e.target.value = '';
        });

        // --- STREAMING TOKENS ---
        socket.on('ai_token', (data) => {
            const box = document.getElementById('answer-box');
            if (!isStreaming) {
                isStreaming = true;
                streamingRaw = '';
                box.innerHTML = '';
            }
            streamingRaw += data.token;
            box.innerHTML = renderAnswer(streamingRaw) + '<span class="streaming-cursor"></span>';
            box.scrollTop = box.scrollHeight;
        });

        socket.on('ai_stream_end', (data) => {
            const box = document.getElementById('answer-box');
            isStreaming = false;
            streamingRaw = '';
            box.innerHTML = renderAnswer(data.full);
            box.scrollTop = box.scrollHeight;
        });

        // --- MODE SWITCHER ---
        function setMode(mode) {
            // Stop recording and reset BOTH mic buttons before switching
            if (isRecording) {
                if (mediaRecorder) mediaRecorder.stop();
                socket.emit('stop_recording');
                isRecording = false;
                if (wakeLock) wakeLock.release();
            }
            // Reset both buttons to default state
            const manualBtn = document.getElementById('btn-manual-mic');
            const autoBtn = document.getElementById('btn-auto-mic');
            manualBtn.classList.add('bg-gray-700');
            manualBtn.classList.remove('bg-red-600', 'animate-pulse');
            manualBtn.querySelector('span:nth-child(2)').innerText = "LISTEN";
            autoBtn.classList.add('bg-gray-700');
            autoBtn.classList.remove('bg-red-600', 'animate-pulse');
            autoBtn.innerHTML = "üéôÔ∏è";

            currentMode = mode;
            socket.emit('set_mode', { mode: mode });

            if (mode === 'manual') {
                document.getElementById('tab-manual').className = "pb-2 w-1/2 font-bold text-center tab-active";
                document.getElementById('tab-auto').className = "pb-2 w-1/2 font-bold text-center tab-inactive";
                document.getElementById('controls-manual').classList.remove('hidden');
                document.getElementById('controls-auto').classList.add('hidden');
                document.getElementById('answer-box').innerHTML = '<p class="text-gray-500 text-center mt-10">Manual Mode.<br>Tap Listen when they speak.<br>Tap Generate to answer.</p>';
                document.getElementById('answer-box').classList.remove('locked-border');
            } else {
                document.getElementById('tab-manual').className = "pb-2 w-1/2 font-bold text-center tab-inactive";
                document.getElementById('tab-auto').className = "pb-2 w-1/2 font-bold text-center tab-active";
                document.getElementById('controls-manual').classList.add('hidden');
                document.getElementById('controls-auto').classList.remove('hidden');
                document.getElementById('answer-box').innerHTML = '<p class="text-gray-500 text-center mt-10">Auto-Pilot Mode.<br>Listening for questions...</p>';
            }
        }

        // --- SOCKET EVENTS ---
        socket.on('connect', () => {
            document.getElementById('connection-dot').className = "w-3 h-3 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]";
            document.getElementById('status-indicator').innerText = "Connected";
            syncContext();
        });

        socket.on('disconnect', () => {
            document.getElementById('connection-dot').className = "w-3 h-3 rounded-full bg-red-500";
        });

        socket.on('status_update', (data) => {
            const statusText = document.getElementById('status-indicator');
            const answerBox = document.getElementById('answer-box');
            statusText.innerText = data.status;

            if (data.status.includes("Locked")) {
                answerBox.classList.add('locked-border');
                statusText.classList.add('text-red-400');
            } else if (data.status.includes("Listening")) {
                answerBox.classList.remove('locked-border');
                statusText.classList.remove('text-red-400');
            }
        });

        socket.on('transcript_update', (data) => {
            const box = document.getElementById('transcript-box');
            const speakerClass = data.speaker === 0 ? 'speaker-0' : 'speaker-1';

            if (currentInterimElement) {
                currentInterimElement.remove();
                currentInterimElement = null;
            }

            if (data.is_final) {
                const p = document.createElement('div');
                p.innerHTML = `<span class="${speakerClass} font-bold">S${data.speaker}:</span> <span class="text-white">${data.text}</span>`;
                p.className = "mb-1";
                box.appendChild(p);
                latestInterimText = '';  // Clear interim since it's now final
            } else {
                const p = document.createElement('div');
                p.innerHTML = `<span class="${speakerClass} font-bold">S${data.speaker}:</span> <span class="interim">${data.text}</span>`;
                p.className = "mb-1";
                box.appendChild(p);
                currentInterimElement = p;
                latestInterimText = `[Speaker ${data.speaker}]: ${data.text}`;  // Save for fast answer
            }
            box.scrollTop = box.scrollHeight;
        });

        // --- LEGACY HANDLER (fallback for non-streamed responses) ---
        socket.on('ai_response', (data) => {
            const box = document.getElementById('answer-box');
            box.innerHTML = renderAnswer(data.answer);
        });

        // --- MIC ---
        function getSupportedMimeType() {
            const types = ['audio/webm;codecs=opus', 'audio/webm', 'audio/mp4', 'audio/aac'];
            for (const type of types) {
                if (MediaRecorder.isTypeSupported(type)) return type;
            }
            return '';
        }

        async function toggleMic() {
            const btn = currentMode === 'manual' ? document.getElementById('btn-manual-mic') : document.getElementById('btn-auto-mic');
            const debugEl = document.getElementById('debug-info');

            if (!isRecording) {
                try {
                    requestWakeLock();
                    syncContext();

                    const stream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: false,
                            noiseSuppression: false,
                            autoGainControl: true,
                            channelCount: 1
                        }
                    });

                    const mimeType = getSupportedMimeType();
                    const options = mimeType ? { mimeType, audioBitsPerSecond: 128000 } : {};

                    try { mediaRecorder = new MediaRecorder(stream, options); }
                    catch (e) { mediaRecorder = new MediaRecorder(stream); }

                    chunkCount = 0;
                    mediaRecorder.ondataavailable = event => {
                        if (event.data.size > 0) {
                            chunkCount++;
                            debugEl.innerText = `Chunks: ${chunkCount}`;
                            socket.emit('binary_audio', event.data);
                        }
                    };

                    mediaRecorder.start(100);
                    socket.emit('start_recording');
                    isRecording = true;

                    if (currentMode === 'manual') {
                        btn.classList.remove('bg-gray-700');
                        btn.classList.add('bg-red-600', 'animate-pulse');
                        btn.querySelector('span:nth-child(2)').innerText = "STOP";
                    } else {
                        btn.classList.remove('bg-gray-700');
                        btn.classList.add('bg-red-600', 'animate-pulse');
                        btn.innerHTML = "‚¨õ";
                    }

                } catch (err) {
                    alert("Mic Error: " + err.message);
                }
            } else {
                if (mediaRecorder) mediaRecorder.stop();
                socket.emit('stop_recording');
                isRecording = false;

                if (currentMode === 'manual') {
                    btn.classList.add('bg-gray-700');
                    btn.classList.remove('bg-red-600', 'animate-pulse');
                    btn.querySelector('span:nth-child(2)').innerText = "LISTEN";
                } else {
                    btn.classList.add('bg-gray-700');
                    btn.classList.remove('bg-red-600', 'animate-pulse');
                    btn.innerHTML = "üéôÔ∏è";
                }

                if (wakeLock) wakeLock.release();
            }
        }

        function manualGetAnswer() {
            document.getElementById('answer-box').innerHTML = '<div class="flex justify-center items-center h-full"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div></div>';
            const transcriptText = document.getElementById('transcript-box').innerText.trim();
            socket.emit('manual_get_answer', { interim: latestInterimText, transcript: transcriptText });
        }

        function forceAnswer() {
            document.getElementById('answer-box').innerHTML = '<div class="flex justify-center items-center h-full"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div></div>';
            const transcriptText = document.getElementById('transcript-box').innerText.trim();
            socket.emit('force_answer', { interim: latestInterimText, transcript: transcriptText });
        }

        // --- RESIZABLE PANELS ---
        (function initResize() {
            const handle = document.getElementById('resize-handle');
            const transcript = document.getElementById('transcript-box');
            const answer = document.getElementById('answer-box');
            const container = transcript.parentElement;
            let isDragging = false;
            let startY = 0;
            let startTranscriptH = 0;
            let startAnswerH = 0;

            function getY(e) {
                return e.touches ? e.touches[0].clientY : e.clientY;
            }

            function onStart(e) {
                isDragging = true;
                startY = getY(e);
                startTranscriptH = transcript.getBoundingClientRect().height;
                startAnswerH = answer.getBoundingClientRect().height;
                document.body.style.userSelect = 'none';
                document.body.style.webkitUserSelect = 'none';
            }

            function onMove(e) {
                if (!isDragging) return;
                e.preventDefault();
                const dy = getY(e) - startY;
                const totalH = startTranscriptH + startAnswerH;
                const minH = 40;
                let newTranscriptH = Math.max(minH, Math.min(totalH - minH, startTranscriptH + dy));
                let newAnswerH = totalH - newTranscriptH;

                transcript.style.flex = 'none';
                transcript.style.height = newTranscriptH + 'px';
                answer.style.flex = 'none';
                answer.style.height = newAnswerH + 'px';
            }

            function onEnd() {
                isDragging = false;
                document.body.style.userSelect = '';
                document.body.style.webkitUserSelect = '';
            }

            handle.addEventListener('mousedown', onStart);
            handle.addEventListener('touchstart', onStart, { passive: true });
            document.addEventListener('mousemove', onMove);
            document.addEventListener('touchmove', onMove, { passive: false });
            document.addEventListener('mouseup', onEnd);
            document.addEventListener('touchend', onEnd);
        })();
    </script>
</body>

</html>
